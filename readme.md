# これはなに？

吉里吉里のTJSでポピュラーな経路探索アルゴリズムであるA*を実装したものです。  
@2dgames_jp様のコードを参考に作られています。  
Limecat制作のゲームで使用したものをベースに整理したものです。  
吉里吉里をメインで開発している方々で2Dゲーを作ってみたいけど経路探索とかわからん、という方がいれば。

# 特徴

## 画像ベースの地形データ

　地形データ画像がただの白黒画像レイヤーなので作成が多分楽です。

## 非同期処理もどき

A*はTJSには重いので計算中も他のキャラクターの移動など他のことが出来るように非同期もどき。
また計算はフレーム単位で分割します。

## 配列を返すだけ

地形データを作成したら始点と終点、計算結果時に呼ばれるコールバックを渡すだけで経路を得られます。
例はKAG前提で書いていますが、依存性はないので他のゲームシステムでも使えるはずです。

# 使い方

使い方はexample.tjsとmanual.tjs を参照して下さい。
kagの場合は、ファイルを全部読み取り可能なフォルダへ入れればサンプルが動作します。

## 地形データ

負荷の軽減のため、地形データは地形画像をグリッドサイズで割った粗い解像度で持っています。  

640x480の地形画像に対してグリッドサイズが16の場合、地形データは40x30になります。

粗い解像度の地形データを作成する際、通行可能か不可か判定されるのはグリッドの中心点です。

## 計算回数

ノードの最大探索回数は`maxSeachNodePerFrame`と`maxSeachCount`を掛けた回数になります。  
広いマップやグリッドが細かい場合は、これらの数値を高くしないと目的地まで到着できない可能性があります。

`maxSeachNodePerFrame`は1フレームで計算する量です。

`interval`はノードを計算するフレームの間隔です。

1秒間に計算するノード数は(1000 / interval) * maxSeachNodePerFrame です。  
規定値だと30fps * 50で1秒間に約150ノードを計算します。

## 返される座標

計算で返される経路はUnityのVector2風のクラスの配列です。  
ですので、計算で返される経路の配列から座標データを取り出す時は次のようになります。

```
var x = path[0].x;
var y = path[0].y;
```


# 最小のコード（KAG使用時の場合）

## 手順
* 地形が書かれた画像tmxdata.pngから地形データを作成
* (100,100)から(400,400)までの経路を計算
* 計算結果を取得後、経路をログに出力

```javascript:sample.tjs

var astar;
var gridSize = 16;
function foo(){
    var tmx = new Layer(kag,kag.fore.base);
    tmx.loadImages("tmxdata.png",gridSize);
    astar = new Astar();
    // 計算開始
    astar.start(100,100,400,400,calced);
}

function calced(path,code)
{
    if(code == 0){
        // 成功
        for(var i = 0; i < path.count;i++)
        {
            var x = path[i].x;
            var y = path[i].y; 

            // 画像での座標
            var lx = x * gridSize;
            var ly = y * gridSize;
            Debug.message("ノードの座標:"+x+ ":"+y);
            Debug.message("画像の座標:"+lx+ ":"+ly);
        }

    }else if(code == 1){
        // ノードが領域外
    }else if(code == 2){
        // 計算回数上限に達しても未到達
    }
}
```
# 欠点と課題

1. 重いので毎フレーム経路を求めるようなリアルタイムには向かない
2. 同じく重いのでピクセル単位のような細かい地形や、複雑な地形には向かない

# tips

　地形情報を画像で持っているので、通行不可や可能をゲーム中に変更したい場合は、colorRectあたりで塗って、createTmxで再生成すればいけるはずです。